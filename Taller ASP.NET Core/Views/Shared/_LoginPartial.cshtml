@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser>
    SignInManager
    @inject UserManager<IdentityUser>
        UserManager

        @{
    var user = await UserManager.GetUserAsync(User);
    var displayName = user?.UserName ?? User.Identity?.Name;
    var initials = !string.IsNullOrEmpty(displayName) && displayName.Length >= 2
        ? displayName.Substring(0, 2).ToUpper()
        : "US";
        }

        @if (SignInManager.IsSignedIn(User))
{
        <div class="dropdown">
            <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle"
               data-bs-toggle="dropdown" aria-expanded="false">
                <!-- Avatar con iniciales -->
                <div class="avatar-circle bg-primary bg-gradient text-white d-flex align-items-center justify-content-center me-2">
                    <span class="fw-bold">@initials</span>
                </div>
                <div class="d-none d-md-block">
                    <span class="fw-medium text-dark">@displayName</span>
                    <small class="d-block text-muted">Mi Cuenta</small>
                </div>
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" style="min-width: 220px;">
                <!-- Header del dropdown -->
                <li class="dropdown-header bg-light py-3">
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle bg-primary bg-gradient text-white d-flex align-items-center justify-content-center me-2">
                            <span class="fw-bold">@initials</span>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">@displayName</h6>
                            <small class="text-muted">@UserManager.GetEmailAsync(user).Result</small>
                        </div>
                    </div>
                </li>
                <li><hr class="dropdown-divider"></li>

                <!-- Enlaces de perfil -->
                <li>
                    <a class="dropdown-item py-2" asp-area="Identity" asp-page="/Account/Manage/Index">
                        <i class="bi bi-person-circle me-2 text-primary"></i>
                        Mi Perfil
                    </a>
                </li>
                <li>
                    <a class="dropdown-item py-2" asp-area="Identity" asp-page="/Account/Manage/Email">
                        <i class="bi bi-envelope me-2 text-primary"></i>
                        Correo Electrónico
                    </a>
                </li>
                <li>
                    <a class="dropdown-item py-2" asp-area="Identity" asp-page="/Account/Manage/ChangePassword">
                        <i class="bi bi-shield-lock me-2 text-primary"></i>
                        Contraseña
                    </a>
                </li>

                <!-- Si tienes tareas -->
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item py-2" asp-controller="Tasks" asp-action="Index">
                        <i class="bi bi-list-task me-2 text-success"></i>
                        Mis Tareas
                    </a>
                </li>
                <li>
                    <a class="dropdown-item py-2" asp-controller="Tasks" asp-action="Create">
                        <i class="bi bi-plus-circle me-2 text-success"></i>
                        Nueva Tarea
                    </a>
                </li>

                <li><hr class="dropdown-divider"></li>

                <!-- Logout -->
                <li>
                    <form asp-area="Identity" asp-page="/Account/Logout"
                          asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })"
                          id="logoutForm">
                        <button type="submit" class="dropdown-item py-2 text-danger" style="cursor: pointer;">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            Cerrar Sesión
                        </button>
                    </form>
                </li>
            </ul>
        </div>
}
else
{
        <div class="d-flex align-items-center gap-2">
            <a class="btn btn-outline-primary btn-sm" asp-area="Identity" asp-page="/Account/Login">
                <i class="bi bi-box-arrow-in-right me-1"></i>
                <span class="d-none d-md-inline">Iniciar Sesión</span>
            </a>
            <a class="btn btn-primary btn-sm" asp-area="Identity" asp-page="/Account/Register">
                <i class="bi bi-person-plus me-1"></i>
                <span class="d-none d-md-inline">Registrarse</span>
            </a>
        </div>
}

        <style>
            .avatar-circle {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                font-size: 0.9rem;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            .dropdown:hover .dropdown-toggle {
                color: #0d6efd !important;
            }

            .dropdown-menu {
                border-radius: 10px;
                margin-top: 10px;
            }

            .dropdown-header {
                border-radius: 10px 10px 0 0;
            }

            .dropdown-item {
                border-radius: 5px;
                margin: 2px 8px;
                width: calc(100% - 16px);
                transition: all 0.2s ease;
            }

                .dropdown-item:hover {
                    background-color: #f8f9fa;
                    transform: translateX(3px);
                }

                .dropdown-item.text-danger:hover {
                    background-color: rgba(220, 53, 69, 0.1);
                }

            /* Estilos para el botón de logout en el formulario */
            form#logoutForm button.dropdown-item {
                border: none;
                background: none;
                width: 100%;
                text-align: left;
            }

            /* Responsive adjustments */
            @@media (max-width: 768px) {
                .avatar-circle {
                    width: 32px;
                    height: 32px;
                    font-size: 0.8rem;
                }

                .dropdown-menu {
                    position: fixed !important;
                    top: auto !important;
                    left: 50% !important;
                    transform: translateX(-50%) !important;
                    width: 90vw;
                    max-width: 300px;
                }
            }
        </style>

        <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Mejorar la experiencia del dropdown en móviles
        const dropdowns = document.querySelectorAll('.dropdown');

        dropdowns.forEach(dropdown => {
            dropdown.addEventListener('show.bs.dropdown', function () {
                if (window.innerWidth < 768) {
                    this.querySelector('.dropdown-menu').classList.add('mobile-dropdown');
                }
            });
        });

        // Confirmación de logout (opcional)
        const logoutForm = document.getElementById('logoutForm');
        if (logoutForm) {
            logoutForm.addEventListener('submit', function(e) {
                if (!confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                    e.preventDefault();
                }
            });
        }
    });
        </script>
